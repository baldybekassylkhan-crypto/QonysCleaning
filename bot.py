import os
import logging
from telegram import Update
from telegram.ext import Application, MessageHandler, CommandHandler, ContextTypes, filters
from groq import Groq

logging.basicConfig(level=logging.INFO)
logging.getLogger("httpx").setLevel(logging.WARNING)

TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
GROQ_API_KEY = os.environ["GROQ_API_KEY"]

client = Groq(api_key=GROQ_API_KEY)

# ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏
MODEL = "llama-3.1-8b-instant"

SYSTEM_PROMPT = """
–†–û–õ–¨: –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ Qonys –≤ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω–µ. –¢–≤–æ—è —Ü–µ–ª—å: –ø—Ä–æ–¥–∞—Ç—å —É—Å–ª—É–≥—É –∏ –∑–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –æ–±—Ä–∞–∑ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

1. –ü–†–ê–í–ò–õ–ê –ö–û–ú–ú–£–ù–ò–ö–ê–¶–ò–ò (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û)
–ë–ï–ó –ü–û–í–¢–û–†–û–í: –ï—Å–ª–∏ –¥–∏–∞–ª–æ–≥ —É–∂–µ –∏–¥–µ—Ç, –ó–ê–ü–†–ï–©–ï–ù–û –∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ. –°—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞.

–î–ò–ù–ê–ú–ò–ö–ê: –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –≤–æ–ø—Ä–æ—Å–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –∫ –∑–∞–ø–∏—Å–∏ (—É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–ª–æ—â–∞–¥–∏, –≤—Ä–µ–º–µ–Ω–∏ –∏–ª–∏ —Ç–∏–ø–∞ —É–±–æ—Ä–∫–∏).

–ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–¨: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç ¬´–Ω–∞ –ª—é–±–æ–µ –≤—Ä–µ–º—è —Å–µ–≥–æ–¥–Ω—è¬ª, –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ç–æ–ª—å–∫–æ —Ç–µ —Å–ª–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª–∏ (—É—á–∏—Ç—ã–≤–∞–π —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è).

2. –î–ê–ù–ù–´–ï –ö–û–ú–ü–ê–ù–ò–ò
–ì–æ—Ä–æ–¥: –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω.

–ê–¥—Ä–µ—Å–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤: –º–∫—Ä. –ö–∞—Ä–∞—Ç–∞–ª 50, –º–∫—Ä. –°–∞–º–∞–ª 3, —É–ª. –®–æ–∫–∞–Ω –£–∞–ª–∏—Ö–∞–Ω–æ–≤ 22. (–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–µ –æ–± –∞–¥—Ä–µ—Å–µ ‚Äî –≤—Å–µ–≥–¥–∞ —É—Ç–æ—á–Ω—è–π —Ä–∞–π–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–π).

–ö–æ–Ω—Ç–∞–∫—Ç—ã: +7 700 684 68 91.

–ì—Ä–∞—Ñ–∏–∫: 09:00 ‚Äì 20:00.

3. –ü–†–ê–ô–°-–õ–ò–°–¢ –ò –†–ê–°–ß–ï–¢
–ë–∞–∑–∞: 300 —Ç–≥/–º¬≤. –¢–∞—Ä–∏—Ñ—ã (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã):

–û–±—ã—á–Ω–∞—è —É–±–æ—Ä–∫–∞: x1.0

–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è —É–±–æ—Ä–∫–∞: x1.2

–ü–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞: x1.5

–î–æ–ø–ª–∞—Ç—ã:

–î–æ—Ä–æ–≥–∞: 0 —Ç–≥ (–≤ –≥–æ—Ä–æ–¥–µ), +2000 —Ç–≥ (–∑–∞ –≥–æ—Ä–æ–¥/—É–¥–∞–ª–µ–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã).

–î–æ–ø—ã: +1500 —Ç–≥ –∑–∞ –∫–∞–∂–¥–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ (–≤–Ω—É—Ç—Ä–∏ —à–∫–∞—Ñ–æ–≤, —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫, –æ–∫–Ω–∞ –∏ —Ç.–¥.).

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ —Ü–µ–Ω—ã:

–ü–ª–æ—â–∞–¥—å: [X] –º¬≤ –¢–∞—Ä–∏—Ñ: [–ù–∞–∑–≤–∞–Ω–∏–µ] –î–æ—Ä–æ–≥–∞: [0/2000] —Ç–≥ –î–æ–ø—ã: [–°—É–º–º–∞] —Ç–≥ –ò—Ç–æ–≥–æ: [–°—É–º–º–∞] —Ç–≥

4. –ì–†–ê–§–ò–ö (–°–õ–û–¢–´)
–°–µ–≥–æ–¥–Ω—è: 11:00, 14:00, 17:00.

–ó–∞–≤—Ç—Ä–∞: 10:00, 13:00, 16:00, 19:00.

–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞: 09:00, 12:00, 15:00, 18:00.

5. –ê–õ–ì–û–†–ò–¢–ú –î–ï–ô–°–¢–í–ò–ô (–°–¶–ï–ù–ê–†–ò–ô)
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç –∑–∞–ø–∏—Å–∞—Ç—å: –°—Ä–∞–∑—É –ø—Ä–µ–¥–ª–∞–≥–∞–π –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞ –ë–ï–ó –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π.

–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –≤—Ä–µ–º—è: –ó–∞–ø—Ä–∞—à–∏–≤–∞–π –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:

–¢–∏–ø —É–±–æ—Ä–∫–∏.

–ê–¥—Ä–µ—Å (—É–ª–∏—Ü–∞/–¥–æ–º).

–ü–ª–æ—â–∞–¥—å –≤ –º¬≤.

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: –°–¥–µ–ª–∞–π —Ä–∞—Å—á–µ—Ç –ø–æ —Ñ–æ—Ä–º—É–ª–µ –∏ –≤—ã–≤–µ–¥–∏ –∏—Ç–æ–≥.

–§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –î–∞—Ç—É, –í—Ä–µ–º—è, –¢–∏–ø –∏ –ê–¥—Ä–µ—Å. –°–ø—Ä–æ—Å–∏: "–•–æ—Ç–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏?"

6. –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ò –û–§–§–¢–û–ü–ê
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–µ –ø–æ —Ç–µ–º–µ: –æ—Ç–≤–µ—Ç—å –≤–µ–∂–ª–∏–≤–æ –∏ –∫–æ—Ä–æ—Ç–∫–æ (–æ–¥–Ω–∞ —Ñ—Ä–∞–∑–∞) –∏ —Å—Ä–∞–∑—É –≤–µ—Ä–Ω–∏ –∫ —Ç–µ–º–µ: "–ü–æ–Ω—è–ª –≤–∞—Å! –¢–∞–∫ –Ω–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –∏ –∞–¥—Ä–µ—Å –æ—Ñ–æ—Ä–º–∏–º —É–±–æ—Ä–∫—É?"

–ó–ê–ü–†–ï–©–ï–ù–û: –æ–±—Å—É–∂–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É, —Ñ–∏–Ω–∞–Ω—Å—ã (–∫—Ä–æ–º–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥), –º–µ–¥–∏—Ü–∏–Ω—É.

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ù–∞—á–Ω–∏ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
"""
MAX_TURNS = 8  # —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–∞—Ä (user+assistant) —Ö—Ä–∞–Ω–∏—Ç—å

CHAT_MESSAGES: dict[int, list[dict]] = {}


def get_messages(chat_id: int) -> list[dict]:
    if chat_id not in CHAT_MESSAGES:
        CHAT_MESSAGES[chat_id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    return CHAT_MESSAGES[chat_id]


def trim_messages(msgs: list[dict]) -> list[dict]:
    system = msgs[:1]
    tail = msgs[1:]
    tail = tail[-(MAX_TURNS * 2):]
    return system + tail


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –Ω–∞ Groq (llama3-8b-8192) ü§ñ\n"
        "–ü–∏—à–∏ —Ç–µ–∫—Å—Ç ‚Äî –æ—Ç–≤–µ—á—É.\n"
        "–ö–æ–º–∞–Ω–¥—ã: /help, /reset"
    )


async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚Ä¢ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî —è –æ—Ç–≤–µ—á—É\n"
        "‚Ä¢ /reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç\n"
        f"–ú–æ–¥–µ–ª—å: {MODEL}"
    )


async def reset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    CHAT_MESSAGES.pop(chat_id, None)
    await update.message.reply_text("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±—Ä–æ—à–µ–Ω üëç")


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    user_text = (update.message.text or "").strip()
    if not user_text:
        return

    msgs = get_messages(chat_id)
    msgs.append({"role": "user", "content": user_text})
    msgs = trim_messages(msgs)
    CHAT_MESSAGES[chat_id] = msgs

    try:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=msgs,
            temperature=0.7,
            max_tokens=512,  # –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        )
        answer = (resp.choices[0].message.content or "").strip() or "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç."
    except Exception as e:
        logging.exception("Groq error")
        answer = f"–û—à–∏–±–∫–∞ Groq: {e}"

    msgs.append({"role": "assistant", "content": answer})
    CHAT_MESSAGES[chat_id] = trim_messages(msgs)

    for i in range(0, len(answer), 3500):
        await update.message.reply_text(answer[i:i + 3500])


def main():
    app = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("reset", reset))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()


if __name__ == "__main__":

    main()




