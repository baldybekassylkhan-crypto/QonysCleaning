import os
import logging
from telegram import Update
from telegram.ext import Application, MessageHandler, CommandHandler, ContextTypes, filters
from groq import Groq

logging.basicConfig(level=logging.INFO)
logging.getLogger("httpx").setLevel(logging.WARNING)

TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
GROQ_API_KEY = os.environ["GROQ_API_KEY"]

client = Groq(api_key=GROQ_API_KEY)

# ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏
MODEL = "llama-3.1-8b-instant"

SYSTEM_PROMPT = """
–í–æ—Ç —á–µ—Ç–∫–∏–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Ä–∞–±–æ—Ç—ã –ò–ò-–∞–≥–µ–Ω—Ç–∞ –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Qonys.

–ü—Ä–æ–º–ø—Ç –ò–ò-–∞–≥–µ–Ω—Ç–∞ –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Qonys
–†–æ–ª—å: –¢—ã ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Qonys –≤ –≥–æ—Ä–æ–¥–µ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏—Ö –Ω–∞ —É–±–æ—Ä–∫—É.

1. –î–ê–ù–ù–´–ï –ö–û–ú–ü–ê–ù–ò–ò (–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –∏—Ö)
–ì–æ—Ä–æ–¥: –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.

–§–∏–ª–∏–∞–ª—ã: –º–∫—Ä. –ö–∞—Ä–∞—Ç–∞–ª 50, –º–∫—Ä. –°–∞–º–∞–ª 3, —É–ª. –®–æ–∫–∞–Ω –£–∞–ª–∏—Ö–∞–Ω–æ–≤ 22.

–ì—Ä–∞—Ñ–∏–∫: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 09:00 –¥–æ 20:00.

–ö–æ–Ω—Ç–∞–∫—Ç—ã: +7 700 684 68 91.

–£—Å–ª—É–≥–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã: * –û–±—ã—á–Ω–∞—è —É–±–æ—Ä–∫–∞ (x1.0)

–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è —É–±–æ—Ä–∫–∞ (x1.2)

–£–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞ (x1.5)

–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: 300 —Ç–≥/–º¬≤.

2. –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –ö–ê–†–¢–û–ô –ò –ê–î–†–ï–°–ê–ú–ò
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥—Ä–µ—Å, —Å–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ –µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (—Ä–∞–π–æ–Ω/–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω).

–ü—Ä–µ–¥–ª–∞–≥–∞–π —Å–∞–º—ã–π –±–ª–∏–∂–∞–π—à–∏–π –∫ –Ω–µ–º—É —Ñ–∏–ª–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω–∞.

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–æ–≤—ã–µ –∞–¥—Ä–µ—Å–∞.

3. –°–í–û–ë–û–î–ù–´–ï –°–õ–û–¢–´ (–ì—Ä–∞—Ñ–∏–∫)
–°–µ–≥–æ–¥–Ω—è: 11:00, 14:00, 17:00.

–ó–∞–≤—Ç—Ä–∞: 10:00, 13:00, 16:00, 19:00.

–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞: 09:00, 12:00, 15:00, 18:00.

–ï—Å–ª–∏ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ, –≤–µ–∂–ª–∏–≤–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É –∏–∑ —Å–ø–∏—Å–∫–∞.

4. –ê–õ–ì–û–†–ò–¢–ú –†–ê–°–ß–ï–¢–ê –°–¢–û–ò–ú–û–°–¢–ò
–§–æ—Ä–º—É–ª–∞: (–ü–ª–æ—â–∞–¥—å * 300 * –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ç–∞—Ä–∏—Ñ–∞) + –î–æ—Ä–æ–≥–∞ + –î–æ–ø—ã.

–î–æ—Ä–æ–≥–∞: 0 —Ç–≥ (–≤ —á–µ—Ä—Ç–µ –≥–æ—Ä–æ–¥–∞), +2000 —Ç–≥ (–µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–∞–π–æ–Ω/–∑–∞ –≥–æ—Ä–æ–¥–æ–º).

–î–æ–ø—ã: +1500 —Ç–≥ –∑–∞ –∫–∞–∂–¥–æ–µ —Å–ø–µ—Ü. –ø–æ–∂–µ–ª–∞–Ω–∏–µ (–º—ã—Ç—å–µ –≤–Ω—É—Ç—Ä–∏ —à–∫–∞—Ñ–æ–≤, –ª—é—Å—Ç—Ä—ã –∏ —Ç.–¥.).

5. –°–¢–ò–õ–¨ –ò –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
–¢–æ–Ω: –í–µ–∂–ª–∏–≤—ã–π, –∫–æ—Ä–æ—Ç–∫–∏–π, –¥–µ–ª–æ–≤–æ–π.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è —É—Ç–æ—á–Ω—è—é—â–∏–º –≤–æ–ø—Ä–æ—Å–æ–º –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∫ –∑–∞–ø–∏—Å–∏.

–¢–∞–±—É: –ù–µ –æ–±—Å—É–∂–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É, –º–µ–¥–∏—Ü–∏–Ω—É, —Ñ–∏–Ω–∞–Ω—Å—ã (–∫—Ä–æ–º–µ –æ–ø–ª–∞—Ç—ã –∫–ª–∏–Ω–∏–Ω–≥–∞). –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–µ –ø–æ —Ç–µ–º–µ ‚Äî –æ—Ç–≤–µ—Ç—å –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π (–Ω-—Ä: "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!") –∏ –≤–µ—Ä–Ω–∏—Å—å –∫ —Ç–µ–º–µ —É–±–æ—Ä–∫–∏.

–ö–ª–∏–µ–Ω—Ç–æ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∞ –Ω–µ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

6. –°–¶–ï–ù–ê–†–ò–ô –î–ò–ê–õ–û–ì–ê
–®–∞–≥ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. > "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Qonys –≤ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω–µ. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å: –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å, —É—Å–ª—É–≥–∏ –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –∫–ª–∏–Ω–∏–Ω–≥?"

–®–∞–≥ 2: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö. –£—Ç–æ—á–Ω–∏ —Ç–∏–ø —É–±–æ—Ä–∫–∏, –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞, –ø–ª–æ—â–∞–¥—å (–º¬≤) –∏ –Ω–∞–ª–∏—á–∏–µ –æ—Å–æ–±—ã—Ö –ø–æ–∂–µ–ª–∞–Ω–∏–π.

–®–∞–≥ 3: –†–∞—Å—á–µ—Ç (–≤—ã–¥–∞–≤–∞—Ç—å –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ):

–ü–ª–æ—â–∞–¥—å: [X] –º¬≤ –¢–∞—Ä–∏—Ñ: [–ù–∞–∑–≤–∞–Ω–∏–µ] (–∫–æ—ç—Ñ.) –î–æ—Ä–æ–≥–∞: [–¶–µ–Ω–∞] —Ç–≥ –î–æ–ø—ã: [–¶–µ–Ω–∞] —Ç–≥ –ò—Ç–æ–≥: [–°—É–º–º–∞] —Ç–≥

–®–∞–≥ 4: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏. –ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π: –ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –î–∞—Ç—É, –í—Ä–µ–º—è, –¢–∏–ø —É–±–æ—Ä–∫–∏ –∏ –ê–¥—Ä–µ—Å. –ó–∞–≤–µ—Ä—à–∏ —Ñ—Ä–∞–∑–æ–π: "–•–æ—Ç–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏?"
"""
MAX_TURNS = 8  # —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–∞—Ä (user+assistant) —Ö—Ä–∞–Ω–∏—Ç—å

CHAT_MESSAGES: dict[int, list[dict]] = {}


def get_messages(chat_id: int) -> list[dict]:
    if chat_id not in CHAT_MESSAGES:
        CHAT_MESSAGES[chat_id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    return CHAT_MESSAGES[chat_id]


def trim_messages(msgs: list[dict]) -> list[dict]:
    system = msgs[:1]
    tail = msgs[1:]
    tail = tail[-(MAX_TURNS * 2):]
    return system + tail


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –Ω–∞ Groq (llama3-8b-8192) ü§ñ\n"
        "–ü–∏—à–∏ —Ç–µ–∫—Å—Ç ‚Äî –æ—Ç–≤–µ—á—É.\n"
        "–ö–æ–º–∞–Ω–¥—ã: /help, /reset"
    )


async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚Ä¢ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî —è –æ—Ç–≤–µ—á—É\n"
        "‚Ä¢ /reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç\n"
        f"–ú–æ–¥–µ–ª—å: {MODEL}"
    )


async def reset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    CHAT_MESSAGES.pop(chat_id, None)
    await update.message.reply_text("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±—Ä–æ—à–µ–Ω üëç")


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    user_text = (update.message.text or "").strip()
    if not user_text:
        return

    msgs = get_messages(chat_id)
    msgs.append({"role": "user", "content": user_text})
    msgs = trim_messages(msgs)
    CHAT_MESSAGES[chat_id] = msgs

    try:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=msgs,
            temperature=0.7,
            max_tokens=512,  # –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        )
        answer = (resp.choices[0].message.content or "").strip() or "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç."
    except Exception as e:
        logging.exception("Groq error")
        answer = f"–û—à–∏–±–∫–∞ Groq: {e}"

    msgs.append({"role": "assistant", "content": answer})
    CHAT_MESSAGES[chat_id] = trim_messages(msgs)

    for i in range(0, len(answer), 3500):
        await update.message.reply_text(answer[i:i + 3500])


def main():
    app = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("reset", reset))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()


if __name__ == "__main__":

    main()



