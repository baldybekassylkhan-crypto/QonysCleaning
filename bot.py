import os
import logging
from telegram import Update
from telegram.ext import Application, MessageHandler, CommandHandler, ContextTypes, filters
from groq import Groq

logging.basicConfig(level=logging.INFO)
logging.getLogger("httpx").setLevel(logging.WARNING)

TELEGRAM_BOT_TOKEN = os.environ["TELEGRAM_BOT_TOKEN"]
GROQ_API_KEY = os.environ["GROQ_API_KEY"]

client = Groq(api_key=GROQ_API_KEY)

# ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏
MODEL = "llama-3.1-8b-instant"

SYSTEM_PROMPT = """
–¢—ã - –ò–ò –∞–≥–µ–Ω—Ç –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Qonys.
–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –¢–û–õ–¨–ö–û –ø–æ —É—Å–ª—É–≥–∞–º –∫–ª–∏–Ω–∏–Ω–≥–∞ –∫–æ–º–ø–∞–Ω–∏–∏ Qonys
–≤ –≥–æ—Ä–æ–¥–µ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.

–ò–∑—É—á–∏ –∫–∞—Ä—Ç—É –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω–∞ –∏ –ø–æ–π–º–∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–∞—Ä—Ç–æ–π

–¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å:
- –ø–æ–º–æ—á—å –∫–ª–∏–µ–Ω—Ç—É –≤—ã–±—Ä–∞—Ç—å —É—Å–ª—É–≥—É –∫–ª–∏–Ω–∏–Ω–≥–∞
- —Å–æ–æ–±—â–∏—Ç—å –∞–¥—Ä–µ—Å –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏
- –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è
- –∑–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —É–±–æ—Ä–∫—É

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø
- –í–µ–∂–ª–∏–≤–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É
- –í—Å–µ–≥–¥–∞ –∑–∞–¥–∞–≤–∞–π —Å–ª–µ–¥—É—é—â–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å,
  —á—Ç–æ–±—ã –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—å –¥–∏–∞–ª–æ–≥ –∫ –∑–∞–ø–∏—Å–∏
- –ù–µ —É—Ö–æ–¥–∏ –≤ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ç–µ–º—ã
- –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –≤—Ä–µ–º—è –∫–æ—Ç–æ—Ä–æ–µ —É–∂–µ –∑–∞–Ω—è—Ç–æ, —Ç–æ —Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
- –ù–ï –æ–±—Å—É–∂–¥–∞–π –ø–æ–ª–∏—Ç–∏–∫—É, –º–µ–¥–∏—Ü–∏–Ω—É, —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –ª—é–±—ã–µ —Ç–µ–º—ã,
  –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–ª–∏–Ω–∏–Ω–≥–æ–º
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –Ω–µ –ø–æ —Ç–µ–º–µ, –æ—Ç–≤–µ—Ç—å –æ–¥–Ω–æ–π
  –∫–æ—Ä–æ—Ç–∫–æ–π –≤–µ–∂–ª–∏–≤–æ–π —Ñ—Ä–∞–∑–æ–π –∏ —Å—Ä–∞–∑—É –≤–µ—Ä–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä
  –∫ –∫–ª–∏–Ω–∏–Ω–≥—É –∏ –∑–∞–ø–∏—Å–∏
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –∞–¥—Ä–µ—Å–∞ –∏ —Ñ–∏–ª–∏–∞–ª—ã
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–î–ê–ù–ù–´–ï –ö–û–ú–ü–ê–ù–ò–ò"

–î–ê–ù–ù–´–ï –ö–û–ú–ü–ê–ù–ò–ò
- –ì–æ—Ä–æ–¥: –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
- –ê–¥—Ä–µ—Å: –ö–∞—Ä–∞—Ç–∞–ª 50, –°–∞–º–∞–ª 3, –®–æ–∫–∞–Ω –£–∞–ª–∏—Ö–∞–Ω–æ–≤ 22
- –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 09:00 –¥–æ 20:00
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 700 684 68 91
- –£—Å–ª—É–≥–∏: –æ–±—ã—á–Ω–∞—è —É–±–æ—Ä–∫–∞, –≥–µ–Ω–µ—Ä–∞–ª—å–Ω–∞—è —É–±–æ—Ä–∫–∞, —É–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞

–°–¶–ï–ù–ê–†–ò–ô –†–ê–ë–û–¢–´

1. –°–¢–ê–†–¢
- –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –°–ø—Ä–æ—Å–∏, —á–µ–º –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å

–ü—Ä–∏–º–µ—Ä:
"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ—â–Ω–∏–∫ –∫–ª–∏–Ω–∏–Ω–≥–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ Qonys –≤ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω–µ.
–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å: –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å, —É—Å–ª—É–≥–∏ –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –∫–ª–∏–Ω–∏–Ω–≥?

2. –ï–°–õ–ò –°–ü–†–ê–®–ò–í–ê–Æ–¢ –ê–î–†–ï–° –ò–õ–ò –ë–õ–ò–ñ–ê–ô–®–ò–ô –ö–õ–ò–ù–ò–ù–ì
- –°–ø—Ä–æ—Å–∏ –µ–≥–æ –∞–¥—Ä–µ—Å—Å, —á—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–π –µ–º—É –∞–¥—Ä–µ—Å—Å
- –¢—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ —Å–∞–º—ã–π –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∏–Ω–∏–Ω–≥, –∞ –Ω–µ —Ä–∞–Ω–¥–æ–º–Ω—ã–π
- –ù–∞–∑–æ–≤–∏ –∞–¥—Ä–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏
- –°–ø—Ä–æ—Å–∏, —á–µ–º –µ—â–µ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
- –ï—Å–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç –Ω–µ –¥–æ–º–æ–º, –∞ –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω–æ–º –∏–ª–∏ —Ä–∞–π–æ–Ω–æ–º, —Ç–æ –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –¢–∞–ª–¥—ã–∫–æ—Ä–≥–∞–Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∏–Ω–∏–Ω–≥ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–ª–∏–µ–Ω—Ç—É

3. –ï–°–õ–ò –°–ü–†–ê–®–ò–í–ê–Æ–¢ –ü–†–û –°–í–û–ë–û–î–ù–û–ï –í–†–ï–ú–Ø
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è

–°–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è:
–°–µ–≥–æ–¥–Ω—è: 11:00, 14:00, 17:00
–ó–∞–≤—Ç—Ä–∞: 10:00, 13:00, 16:00, 19:00
–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞: 09:00, 12:00, 15:00, 18:00

- –ü—Ä–µ–¥–ª–æ–∂–∏ 2-4 –±–ª–∏–∂–∞–π—à–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
- –°–ø—Ä–æ—Å–∏, –Ω–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∞—Ç—å

4. –ó–ê–ü–ò–°–¨ –ö–õ–ò–ï–ù–¢–ê
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –≤—Ä–µ–º—è:
- –£—Ç–æ—á–Ω–∏ –∏–º—è
- –ê–¥—Ä–µ—Å —É–±–æ—Ä–∫–∏
- –¢–∏–ø —É–±–æ—Ä–∫–∏
- –ü–ª–æ—â–∞–¥—å –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ)
- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω)

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞–ø–∏—Å—å:
"–û—Ç–ª–∏—á–Ω–æ! –Ø –∑–∞–ø–∏—Å–∞–ª –≤–∞—Å –Ω–∞ —É–±–æ—Ä–∫—É.
–î–∞—Ç–∞: [–¥–∞—Ç–∞]
–í—Ä–µ–º—è: [–≤—Ä–µ–º—è]
–ê–¥—Ä–µ—Å: [–∞–¥—Ä–µ—Å]
–¢–∏–ø —É–±–æ—Ä–∫–∏: [—Ç–∏–ø]"

–ó–∞—Ç–µ–º —Å–ø—Ä–æ—Å–∏:
"–•–æ—Ç–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏?"

5. –ï–°–õ–ò –í–†–ï–ú–Ø –ù–ï –ü–û–î–•–û–î–ò–¢
- –°–ø—Ä–æ—Å–∏, –∫–∞–∫–æ–π –¥–µ–Ω—å –∏–ª–∏ –≤—Ä–µ–º—è —É–¥–æ–±–Ω—ã
- –ü—Ä–µ–¥–ª–æ–∂–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
- –°–Ω–æ–≤–∞ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –æ –∑–∞–ø–∏—Å–∏

6. –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–ò–®–ï–¢ –ù–ï –ü–û –¢–ï–ú–ï
- –û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
- –°—Ä–∞–∑—É –≤–µ—Ä–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –∫ –∑–∞–ø–∏—Å–∏

–ü—Ä–∏–º–µ—Ä—ã:
"–ö–ª–∞—Å—Å–Ω–æ! –ê –Ω–∞ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –≤–∞—Å –∑–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —É–±–æ—Ä–∫—É?"
"–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –∫–æ–≥–¥–∞ –≤–∞–º –±—É–¥–µ—Ç —É–¥–æ–±–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–±–æ—Ä–∫—É?"

–ü–†–ê–í–ò–õ–û –ö–û–ù–¢–ï–ö–°–¢–ê
- –ó–∞–ø–æ–º–∏–Ω–∞–π –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –¥–∞—Ç—É, —Ç–∏–ø —É–±–æ—Ä–∫–∏ –∏ –∞–¥—Ä–µ—Å,
  –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏—Ö —Å–æ–æ–±—â–∏–ª
- –ù–µ –º–µ–Ω—è–π —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã
- –ü–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–º,
  –∫–æ—Ç–æ—Ä—ã–π –≤–µ–¥–µ—Ç –∫ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É–±–æ—Ä–∫—É
"""
MAX_TURNS = 8  # —Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–∞—Ä (user+assistant) —Ö—Ä–∞–Ω–∏—Ç—å

CHAT_MESSAGES: dict[int, list[dict]] = {}


def get_messages(chat_id: int) -> list[dict]:
    if chat_id not in CHAT_MESSAGES:
        CHAT_MESSAGES[chat_id] = [{"role": "system", "content": SYSTEM_PROMPT}]
    return CHAT_MESSAGES[chat_id]


def trim_messages(msgs: list[dict]) -> list[dict]:
    system = msgs[:1]
    tail = msgs[1:]
    tail = tail[-(MAX_TURNS * 2):]
    return system + tail


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –Ω–∞ Groq (llama3-8b-8192) ü§ñ\n"
        "–ü–∏—à–∏ —Ç–µ–∫—Å—Ç ‚Äî –æ—Ç–≤–µ—á—É.\n"
        "–ö–æ–º–∞–Ω–¥—ã: /help, /reset"
    )


async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚Ä¢ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç ‚Äî —è –æ—Ç–≤–µ—á—É\n"
        "‚Ä¢ /reset ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç\n"
        f"–ú–æ–¥–µ–ª—å: {MODEL}"
    )


async def reset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    CHAT_MESSAGES.pop(chat_id, None)
    await update.message.reply_text("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–±—Ä–æ—à–µ–Ω üëç")


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    user_text = (update.message.text or "").strip()
    if not user_text:
        return

    msgs = get_messages(chat_id)
    msgs.append({"role": "user", "content": user_text})
    msgs = trim_messages(msgs)
    CHAT_MESSAGES[chat_id] = msgs

    try:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=msgs,
            temperature=0.7,
            max_tokens=512,  # –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        )
        answer = (resp.choices[0].message.content or "").strip() or "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç."
    except Exception as e:
        logging.exception("Groq error")
        answer = f"–û—à–∏–±–∫–∞ Groq: {e}"

    msgs.append({"role": "assistant", "content": answer})
    CHAT_MESSAGES[chat_id] = trim_messages(msgs)

    for i in range(0, len(answer), 3500):
        await update.message.reply_text(answer[i:i + 3500])


def main():
    app = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("reset", reset))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()


if __name__ == "__main__":

    main()
